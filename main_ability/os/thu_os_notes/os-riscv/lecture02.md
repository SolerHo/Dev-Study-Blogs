## 第02讲 操作系统与系统结构和程序设计语言

### 1. 从OS角度看计算机系统
#### 1.1 隔离
**程序调用的特征**
- 好处
    - 执行快
    - 程序员熟悉的机制
- 坏处
    - 灵活-易于传递和返回复杂的数据类型
    - 应用程序不可靠，可能存在恶意、崩溃等风险。

**隔离的目的**：强制隔离以避免对整个系统的可用性/可靠性/安全影响。

运行的程序通常是隔离的单元。

**需要隔离的地方**
- 防止程序X破坏或监视程序Y
    - 读/写内存，使用100%的CPU，更改文件描述符
- 防止进程干扰OS
- 防止恶意程序、病毒、木马和Bug
    - 错误的过程可能会试图欺骗硬件或内核。

**隔离的方法**
-  地址空间（Address Spaces）
    - 一个程序仅寻址其自己的内存
    - 每个程序若无许可，则无法访问不属于自己的内存
- CPU硬件中的特权模式/中断机制
    - 防止应用程序访问设备或敏感的CPU寄存器
    - 例如地址空间配置寄存器
    - 例如打断一直占用CPU的应用程序


#### 1.2 虚拟内存

#### 1.3 特权模式
- CPU硬件支持不同的特权模式
    - Kernel Mode（内核态） vs User Mode（用户态）
    - Kernel Mode 可以执行User Mode无法执行的特权操作
        - 访问外设
        - 配置地址空间（虚拟内存）
        - 读/写特殊系统寄存器
    - OS Kernel 运行在Kernel Mode
    - 应用程序运行在User Mode
    - 每个重要的微处理器都有类似的用户/内核模式标志。
#### 1.4 中断机制
- CPU硬件支持中断/异常的处理
- 中断是异步发生，是来自于处理器外部的I/O设备的信号的结果。
    - 硬件中断不是由任何一条专门的CPU指令造成，从此意义上是异步的。

- 硬件中断的异常处理程序通常称为`中断处理程序（interrupt handle）`。
    - I/O设备通过向处理器芯片的一个引脚发信号，并将异常信号放到系统总线上，以触发中断。
    - 在当前指令执行完后，处理器从系统总线读取异常号，保存现场，切换到Kernel mode
    - 调用中断处理程序，当中断处理程序完成后，它将控制返回给下一条本来要执行的指令。
- Timer定时器：可以稳定定时地产生中断
    - 防止应用程序死占CPU不放
    - 让OS Kernel 能周期性地进行资源管理。

### 2. RISC-V知识点补充（自我学习补充）

#### 2.1 RISC-V特权模式架构：控制状态寄存器
- 防止应用程序访问设备和敏感的CPU寄存器（如地址空间配置寄存器）

- 强制隔离以避免对整个系统的可用性/可靠性/安全影响
- 运行的程序通常是隔离的单元
- 防止恶意程序、病毒、木马破坏或监视应用程序或干扰操作系统
    - 读/写内存：mstatus/satp CSR
    - 使用100%的CPU：mastatus/stvec CSR
    - mastatus/satp/stvec CSR页表异常处理。

#### 2.2 RISC-V虚拟内存
- 有虚拟内存的好处/坏处
    - 灵活的不连续内存分配
    - 多个运行程序的地址空间相互隔离/共享
    - 进一步隔离应用程序与OS内核
    - 多了访问页表的开销

#### 2.3 RISC-V 中断机制
- 中断是异步发生，是来自处理器外部的I/O设备的信号的结果。
- Timer可以稳定定时地产生中断
    - 防止应用程序死占着CPU不放，让OS Kernel能得到执行权。
    - 由高特权模式下的软件获得CPU控制权
    - 也可由高特权模式下的软件授权低特权模式软件处理中断。

### 3. Rust语言和系统编程

#### 3.1 系统编程语言
- 用于构建控制低层计算机硬件的软件系统，并提供由用于构建应用程序和服务的更高级应用程序编程语言使用的软件平台。
- 开发OS的系统编程语言很多，也离不开汇编语言。


#### 3.2 选择Rust原因
- CS140e：Stanford 实验性课程 Rust OS for Raspi3
- RVirt：MIT RISC-V Hypervisor
- Writing an OS in Rust --- BlogOS 详尽的Rust OS教程
- 产业界：蚂蚁金服：Occlum --- Facebook：Libra

#### 3.3 Rust主要特性
- 内存 + 线程安全
- 高级语言特性
- 成熟的工具链
- 友好的社区（OS示例代码 + 文档）生态
- 学习Rust的入门门槛比较高。

### 4. RISC-V CPU启动





